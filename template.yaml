AWSTemplateFormatVersion: "2010-09-09"
Description: >

    This template deploys the Gureume Platform Infrastructure together
    with the necessary exports for the Gureume Management API to integrate
    correctly.

    Last Modified: 9th October 2018
    Modified By: Karl Wallbom <wallbomk@amazon.com>
    Author: Paul Maddox <pmaddox@amazon.com>

Parameters:

    # Defines if the template should create EC2 instances in the ECS cluster.
    # Leave this at 0 if you plan to only use Fargate.
    ClusterSize:
        Description: How many ECS hosts do you want to initially deploy?
        Type: Number
        Default: 0

Conditions:

    ASGExists:
        !Not [!Equals [!Ref ClusterSize, "0"]]

Resources:

    VPC:
        Type: AWS::CloudFormation::Stack
        Properties:
            TemplateURL: infrastructure/vpc.yaml
            Parameters:
                EnvironmentName:    !Ref AWS::StackName
                VpcCIDR:            10.180.0.0/16
                PublicSubnet1CIDR:  10.180.8.0/21
                PublicSubnet2CIDR:  10.180.16.0/21
                PrivateSubnet1CIDR: 10.180.24.0/21
                PrivateSubnet2CIDR: 10.180.32.0/21

    ALB:
        Type: AWS::CloudFormation::Stack
        Properties:
            TemplateURL: infrastructure/load-balancers.yaml
            Parameters:
                EnvironmentName: !Ref AWS::StackName
                VPC: !GetAtt VPC.Outputs.VPC
                Subnets: !GetAtt VPC.Outputs.PublicSubnets

    ECS:
        Type: AWS::CloudFormation::Stack
        Properties:
            TemplateURL: infrastructure/ecs-cluster.yaml
            Parameters:
                EnvironmentName: !Ref AWS::StackName
                InstanceType: t2.small
                ClusterSize: !Ref ClusterSize
                VPC: !GetAtt VPC.Outputs.VPC
                Subnets: !GetAtt VPC.Outputs.PrivateSubnets
                LoadBalancerSecurityGroup: !GetAtt ALB.Outputs.LoadBalancerSecurityGroup

    LifecycleHook:
        Type: AWS::CloudFormation::Stack
        Condition: ASGExists
        Properties:
            TemplateURL: infrastructure/lifecyclehook.yaml
            Parameters:
                Cluster: !GetAtt ECS.Outputs.Cluster
                ECSAutoScalingGroupName: !GetAtt ECS.Outputs.ECSAutoScalingGroupName

    ServiceDiscovery:
        Type: AWS::CloudFormation::Stack
        Properties:
            TemplateURL: infrastructure/service-discovery.yaml
            Parameters:
                NamespaceName: !GetAtt ECS.Outputs.Cluster
                VPC: !GetAtt VPC.Outputs.VPC

    AppDeploymentRole:
        Type: AWS::IAM::Role
        Properties:
            Path: /
            RoleName: !Sub ${AWS::StackName}-AppDeploymentRole-${AWS::Region}
            AssumeRolePolicyDocument: |
                {
                    "Statement": [{
                        "Action": "sts:AssumeRole",
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "cloudformation.amazonaws.com"
                        }
                    }]
                }
            ManagedPolicyArns:
              - arn:aws:iam::aws:policy/PowerUserAccess
              - arn:aws:iam::aws:policy/IAMFullAccess
