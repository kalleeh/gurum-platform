AWSTemplateFormatVersion: "2010-09-09"
Description: S3 Backing Service

Parameters:

#  LinkedRoles:
#    Description: Comma-separated list for role names to add permissions to
#    Type: AWS::SSM::Parameter
#    Default: /gureume/services/myservicenamespace/linked_roles
    
  LinkedRoles:
    Description: Comma-separated list for role names to add permissions to
    Type: String
    Default: "arn:aws:iam::789073296014:role/gureume-team1-role,arn:aws:iam::789073296014:role/gureume-team2-role"

Resources:

  S3Bucket:
    Type: 'AWS::S3::Bucket'

  BucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      PolicyDocument:
        Id: Policy
        Version: 2012-10-17
        Statement:
          - Sid: ReadWriteFromApp
            Effect: Allow
            Principal:
              AWS: !Split
                - ','
                - !Sub
                  - '${LinkedRolesList}'
                  - LinkedRolesList: !Join [',', [ !Ref LinkedRoles ] ]
            Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Resource: !Join [ '', [ 'arn:aws:s3:::', !Ref S3Bucket, '/*' ] ]
      Bucket: !Ref S3Bucket

Outputs:
  ServiceArn:
    Value: !GetAtt S3Bucket.Arn